name: Package Release

on:
  workflow_call:
    secrets:
      pull-request-token:
        description: "Token to open a pull request to the package repository."
        required: true
    inputs:
      package-name-slug:
        description: "The Carvel package name slug (e.g. knative-serving)."
        required: true
        type: string
      package-name-display:
        description: "The Carvel package name display (e.g. Knative Serving)."
        required: true
        type: string
      registry-server:
        description: "URL of the container registry."
        required: true
        type: string
        default: ghcr.io
      registry-username:
        description: "Username to log into the container registry."
        required: true
        type: string
        default: ${{ github.actor }}
      image:
        description: "The OCI image name. This must not include a tag or digest."
        required: true
        type: string
        default: ${{ github.repository }}
      version:
        description: "The OCI image version following semantic versioning."
        required: true
        type: string

permissions:
  contents: read

env:
  FLOX_DISABLE_METRICS: true

jobs:
  build:
    name: Build
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      packages: write
    outputs:
      image-name: ${{ steps.image-info.outputs.image_name }}
      image-digest: ${{ steps.image-info.outputs.image_digest }}
    steps:
      - name: Checkout source code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Install Flox
        uses: flox/install-flox-action@9428713e8d3883274c334b4b95b8830beebd24d2 # v2.3.0

      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@00f483c95eacf401cf9f4aa3746964071a747334 # master
      
      - name: Install kctrl
        run: |
          brew tap carvel-dev/carvel
          brew install kctrl
      
      - name: Log into container registry
        uses: flox/activate-action@410568008895a0f2e09a34bbd9523f8ef1f2d292 # v1.1.0
        with:
          command: |
            echo "${{ secrets.GITHUB_TOKEN }}" | podman login "${{ inputs.registry-server }}" \
              --username "${{ inputs.registry-username }}" \
              --password-stdin
      
      - name: Create k3d cluster
        uses: flox/activate-action@410568008895a0f2e09a34bbd9523f8ef1f2d292 # v1.1.0
        with:
          command: |
            k3d cluster create test-cluster
            kubectl wait --for=condition=Ready nodes --all --timeout=5m
      
      - name: Package and publish OCI bundle
        uses: flox/activate-action@410568008895a0f2e09a34bbd9523f8ef1f2d292 # v1.1.0
        with:
          command: |
            image_tag=$(echo ${{ inputs.version }} | tr + -)
            kctrl package release -y --version ${{ inputs.version }} \
              --build-ytt-validations=false \
              --chdir package \
              --copy-to ../carvel-artifacts \
              --repo-output ../repo \
              --tag ${image_tag}
      
      - name: Get released OCI image name with digest
        uses: flox/activate-action@410568008895a0f2e09a34bbd9523f8ef1f2d292 # v1.1.0
        id: image-info
        with:
          command: |
            package_file=$(find carvel-artifacts/packages -name 'package.yml')
            image_release=$(yq '.spec.template.spec.fetch[0].imgpkgBundle.image' ${package_file})
            echo "IMAGE_RELEASE=${image_release}" >> $GITHUB_ENV

            echo "image_name=$(echo ${image_release} | cut -d'@' -f1)" >> $GITHUB_OUTPUT
            echo "image_digest=$(echo ${image_release} | cut -d'@' -f2)" >> $GITHUB_OUTPUT

      - name: Add additional tags to OCI image
        uses: flox/activate-action@410568008895a0f2e09a34bbd9523f8ef1f2d292 # v1.1.0
        with:
          command: |
            podman pull ${IMAGE_RELEASE}
            podman tag ${IMAGE_RELEASE} ${{ inputs.registry-server }}/${{ inputs.image }}:latest
            podman push ${{ inputs.registry-server }}/${{ inputs.image }}:latest

      - name: Create a release
        uses: flox/activate-action@410568008895a0f2e09a34bbd9523f8ef1f2d292 # v1.1.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          command: |
            gh release create v${{ inputs.version }} \
                --generate-notes \
                ./carvel-artifacts/packages/${{ inputs.package-name-slug }}.packages.kadras.io/package.yml \
                ./carvel-artifacts/packages/${{ inputs.package-name-slug }}.packages.kadras.io/metadata.yml \
                ./README.md
      
      - name: Upload package.yml artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: ${{ inputs.version }}.yml
          path: ./repo/packages/${{ inputs.package-name-slug }}.packages.kadras.io/${{ inputs.version }}.yml
          retention-days: 1
      
      - name: Upload metadata.yml artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: metadata.yml
          path: ./repo/packages/${{ inputs.package-name-slug }}.packages.kadras.io/metadata.yml
          retention-days: 1

  sign:
    name: Sign
    runs-on: ubuntu-24.04
    needs: [build]
    permissions:
      packages: write
      id-token: write
    env:
      IMAGE_NAME: ${{ needs.build.outputs.image-name }}
      IMAGE_DIGEST: ${{ needs.build.outputs.image-digest }}
    steps:
      - name: Log into container registry
        uses: flox/activate-action@410568008895a0f2e09a34bbd9523f8ef1f2d292 # v1.1.0
        with:
          command: |
            echo "${{ secrets.GITHUB_TOKEN }}" | podman login "${{ inputs.registry-server }}" \
              --username "${{ inputs.registry-username }}" \
              --password-stdin
      
      - name: Sign image using Cosign
        uses: flox/activate-action@410568008895a0f2e09a34bbd9523f8ef1f2d292 # v1.1.0
        with:
          command: cosign sign --yes "${IMAGE_NAME}@${IMAGE_DIGEST}"
  
  provenance:
    needs: [build,sign]
    permissions:
      actions: read
      id-token: write
      packages: write
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.1.0
    with:
      image: ${{ needs.build.outputs.image-name }}
      digest: ${{ needs.build.outputs.image-digest }}
      registry-username: ${{ inputs.registry-username }}
    secrets:
      registry-password: ${{ secrets.GITHUB_TOKEN }}

  repo:
    name: Package Repository
    runs-on: ubuntu-24.04
    needs: [provenance]
    permissions:
      contents: read
    env:
      PACKAGE_REPO: kadras-packages
    steps:
      - name: Download package.yml artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: ${{ inputs.version }}.yml
          path: ./artifacts
      
      - name: Download metadata.yml artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4.3.0
        with:
          name: metadata.yml
          path: ./artifacts

      - name: Checkout package repository source code
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          path: kadras-packages
          repository: ${{ github.repository_owner }}/${{ env.PACKAGE_REPO }}
          ref: main
          token: ${{ secrets.pull-request-token }}

      - name: Push release artifacts to package repository
        env:
          GH_TOKEN: ${{ secrets.pull-request-token }}
        run: |
          package_path=kadras-packages/repo/packages/${{ inputs.package-name-slug }}.packages.kadras.io
          if [ ! -f ${package_path} ]; then
            mkdir -p ${package_path}
          fi

          mv -f artifacts/${{ inputs.version }}.yml ${package_path}/${{ inputs.version }}.yml
          mv -f artifacts/metadata.yml ${package_path}/metadata.yml

          cd kadras-packages

          git config user.name github-actions
          git config user.email github-actions@github.com

          branch_name=$(date +%s | base64)
          git checkout -b ${branch_name}

          git add repo/packages/${{ inputs.package-name-slug }}.packages.kadras.io/${{ inputs.version }}.yml
          git add repo/packages/${{ inputs.package-name-slug }}.packages.kadras.io/metadata.yml

          git commit -m "Update ${{ inputs.package-name-display }} metadata and add version ${{ inputs.version }}"
          git push origin ${branch_name}

          gh pr create -f --base main --title "Add ${{ inputs.package-name-display }} ${{ inputs.version }}" --body "Update ${{ inputs.package-name-display }} metadata and add version ${{ inputs.version }}"
